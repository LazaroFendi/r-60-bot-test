<!-- a5a62675-03c7-4c19-bd21-d97bf652e209 db362502-c45e-4e72-b89d-abfc4424da9c -->
# Plan de Implementaci√≥n: R-60 Bot

## Fase 1: Configuraci√≥n Base del Proyecto

Establecer la estructura fundamental y archivos de configuraci√≥n.

### 1.1 Estructura de Carpetas

- Crear estructura completa de directorios (`src/`, `credentials/`, `temp/`, `logs/`, etc.)
- Agregar archivos `.gitkeep` en carpetas vac√≠as

### 1.2 Archivos de Configuraci√≥n Esenciales

- `.gitignore`: Excluir credenciales, logs, temp, cache Python
- `.dockerignore`: Optimizar imagen Docker
- `requirements.txt`: Dependencias completas con versiones espec√≠ficas
- `.env.example`: Plantilla documentada de variables de entorno

**‚úÖ Checkpoint Fase 1:** Verificar estructura y configuraci√≥n base

---

## Fase 2: Utilidades y Fundamentos

Construir los componentes base que usar√°n todos los m√≥dulos.

### 2.1 Sistema de Excepciones Personalizadas

- `src/utils/exceptions.py`: Definir excepciones espec√≠ficas del dominio
- `FormularioDuplicadoError`
- `CampoObligatorioError`
- `TipoFormularioNoReconocidoError`
- `GoogleAPIError`

### 2.2 Sistema de Logging Centralizado

- `src/utils/logger.py`: Configurar logging robusto
- Rotaci√≥n de archivos por fecha
- Niveles: DEBUG para desarrollo, INFO para producci√≥n
- Formato estructurado con timestamps

### 2.3 Configuraci√≥n Centralizada

- `config.py`: Constantes y mapeo de celdas R-60
- Mapeo de celdas por tipo de formulario (Compras, Servicios, Costos)
- Configuraci√≥n de queries Gmail
- Estructura de carpetas Drive
- Encabezados Sheet

**‚úÖ Checkpoint Fase 2:** Validar utilidades base funcionando correctamente

---

## Fase 3: Autenticaci√≥n Google OAuth2

Implementar el flujo de autenticaci√≥n centralizado.

### 3.1 M√≥dulo de Autenticaci√≥n

- `src/auth/google_auth.py`: Flujo OAuth2 completo
- Verificar `token.json` existente y v√°lido
- Si no existe, buscar `credentials.json`
- **üîë PUNTO DE PAUSA:** Si `credentials.json` no existe, solicitar al usuario
- Iniciar flujo OAuth2 con navegador
- Guardar `token.json` para futuros usos
- Funci√≥n `get_credentials(scopes)` reutilizable

**‚úÖ Checkpoint Fase 3:** Autenticaci√≥n exitosa y token guardado

---

## Fase 4: Servicios Google APIs

Implementar encapsulaci√≥n completa de cada API.

### 4.1 Gmail Service

- `src/services/gmail_service.py`:
- `search_emails(query)`: Buscar emails con adjuntos R-60
- `download_attachment(message_id, attachment_id)`: Descargar Excel
- `add_label(message_id, label_name)`: Etiquetar (Procesado/Error/Duplicado)
- `send_notification(to, subject, body_html)`: Enviar confirmaciones
- Crear etiquetas si no existen

### 4.2 Sheets Service

- `src/services/sheets_service.py`:
- `ensure_header_exists(sheet_id)`: Crear encabezado si falta
- `check_duplicate(sheet_id, form_number)`: Verificar duplicados
- `append_rows(sheet_id, data)`: Escribir datos (batch para m√∫ltiples √≠tems)
- Manejo de cuotas y reintentos

### 4.3 Drive Service

- `src/services/drive_service.py`:
- `ensure_folder_structure(year, month)`: Crear `/R60_PROCESADOS/YYYY/MM/`
- `upload_file(file_path, folder_id, new_name)`: Subir y renombrar Excel
- Buscar carpetas por nombre, crear si no existen

**‚úÖ Checkpoint Fase 4:** Cada servicio probado individualmente

---

## Fase 5: Parser de Formularios R-60

Implementar la inteligencia de extracci√≥n de datos.

### 5.1 Excel Parser

- `src/parsers/excel_parser.py`:
- `identify_form_type(workbook)`: Detectar tipo autom√°ticamente
- `extract_header_data(sheet, form_type)`: Extraer encabezado seg√∫n mapeo
- `extract_items_data(sheet, form_type)`: Iterar tabla hasta fila vac√≠a
- `parse_r60_form(file_path)`: Funci√≥n principal que retorna dict estructurado
- Validaciones robustas de campos obligatorios
- Manejo de celdas vac√≠as y formatos

**‚úÖ Checkpoint Fase 5:** Parser validado con diferentes formularios ejemplo

---

## Fase 6: Orquestador Principal

Integrar todos los m√≥dulos en el flujo completo.

### 6.1 Main Script

- `main.py`:
- Inicializar logger
- Autenticar y obtener credenciales
- Inicializar servicios (Gmail, Sheets, Drive)
- Buscar emails con query configurada
- **Loop por cada email:**

1. Try/except para manejo robusto de errores
2. Descargar adjunto a `/temp/`
3. Parsear Excel
4. Verificar duplicados
5. Escribir en Sheets (si no es duplicado)
6. Archivar en Drive
7. Notificar √©xito y etiquetar
8. Limpiar archivo temporal

- **En caso de error:**
- Enviar email de error con detalles
- Etiquetar email con "Error"
- Registrar en logs

**‚úÖ Checkpoint Fase 6:** Flujo end-to-end funcionando correctamente

---

## Fase 7: Dockerizaci√≥n y Despliegue

Preparar para producci√≥n con contenedores.

### 7.1 Docker

- `Dockerfile`: Multi-etapa para imagen optimizada
- Base: Python 3.11-slim
- Instalar dependencias
- Copiar c√≥digo fuente
- Usuario no-root para seguridad
- Health check
- Labels para mejor visualizaci√≥n en Portainer

### 7.2 Docker Compose (Optimizado para Portainer)

- `docker-compose.yml`:
- Configuraci√≥n de vol√∫menes nombrados para credenciales y logs (persisten en Portainer)
- Variables de entorno desde archivo `.env` o variables de Portainer
- Labels descriptivos para la UI de Portainer
- Restart policy: unless-stopped
- Networking apropiado
- Healthcheck para monitoreo en Portainer

### 7.3 Stack Template para Portainer

- `portainer-stack.yml`: Template espec√≠fico para deploy directo en Portainer
- Variables de entorno como placeholders editables en la UI
- Configuraci√≥n de vol√∫menes persistent
- Anotaciones para la interfaz de Portainer

**‚úÖ Checkpoint Fase 7:** Contenedor construido, probado y desplegable en Portainer

---

## Fase 8: Documentaci√≥n Final

Crear documentaci√≥n completa para usuarios.

### 8.1 README Completo

- `README.md`:
- Descripci√≥n del proyecto
- Requisitos previos
- Configuraci√≥n paso a paso:
- Obtener credenciales Google Cloud Console
- Configurar `.env`
- Setup local vs Docker
- Despliegue en Portainer con capturas conceptuales
- Configuraci√≥n de cron job para ejecuci√≥n peri√≥dica
- Troubleshooting com√∫n
- Estructura del proyecto explicada

**‚úÖ Checkpoint Final:** Documentaci√≥n clara y completa

---

## Resumen de Puntos de Pausa

- **Fase 3:** Solicitar `credentials.json` al usuario cuando sea necesario
- Cada checkpoint debe validarse antes de avanzar a la siguiente fase

### To-dos

- [ ] Crear estructura de carpetas y archivos de configuraci√≥n base (.gitignore, .dockerignore, requirements.txt, .env.example)
- [ ] Implementar utilidades base: excepciones personalizadas, sistema de logging y config.py
- [ ] Implementar m√≥dulo de autenticaci√≥n OAuth2 con Google (solicitar credentials.json al usuario cuando sea necesario)
- [ ] Implementar servicios de Gmail, Sheets y Drive con encapsulaci√≥n completa
- [ ] Implementar parser de formularios R-60 con detecci√≥n autom√°tica de tipo
- [ ] Implementar orquestador principal (main.py) integrando todos los m√≥dulos
- [ ] Crear Dockerfile multi-etapa y docker-compose.yml para producci√≥n
- [ ] Redactar README.md completo con gu√≠as de configuraci√≥n y despliegue